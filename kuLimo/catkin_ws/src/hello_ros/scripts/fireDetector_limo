#!/usr/bin/env python
import rospy
import cv2
import time
import os
from sensor_msgs.msg import Image
from geometry_msgs.msg import Twist
from cv_bridge import CvBridge

from std_msgs.msg import Bool 

class FireDetector:
    def __init__(self):
        rospy.init_node('fire_detector', anonymous=True)
        self.bridge = CvBridge()

        self.ns = rospy.get_namespace()
        if self.ns == '/':
            self.ns = ''

        # âœ… ê²½ê³ ìŒ íŒŒì¼ ê²½ë¡œë¥¼ LIMO ë¡œë´‡ì˜ ì‹¤ì œ ê²½ë¡œë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.
        self.alarm_sound = "/home/sejongtp08/fire_alarm.wav" 

        self.last_alarm_time = 0
        self.alarm_interval = 5

        self.image_sub = rospy.Subscriber(self.ns + "camera/rgb/image_raw", Image, self.callback)
        self.fire_alert_pub = rospy.Publisher(self.ns + "fire_alert", Bool, queue_size=1)
        self.is_fire_detected = False

        rospy.loginfo(f"[{self.ns.strip('/')}] í™”ì¬ ê°ì§€ ë…¸ë“œ ì´ˆê¸°í™” ì™„ë£Œ.")

    def play_alarm(self):
        """
        3ì´ˆ ë™ì•ˆ ê²½ê³ ìŒ ì¬ìƒ.
        ì•ŒëŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ê²½ê³  ë©”ì‹œì§€ë§Œ ì¶œë ¥í•˜ê³  ì¬ìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        """
        if not os.path.exists(self.alarm_sound): # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            rospy.logerr(f"[{self.ns.strip('/')}] ê²½ê³ ìŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {self.alarm_sound}")
            return # íŒŒì¼ì´ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ

        cmd = f"timeout 3s aplay {self.alarm_sound} &"
        os.system(cmd)
        rospy.loginfo(f"[{self.ns.strip('/')}] ê²½ê³ ìŒ ì¬ìƒ ì¤‘: {self.alarm_sound}")

    def callback(self, data):
        frame = self.bridge.imgmsg_to_cv2(data, desired_encoding="bgr8")
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)

        lower_red1 = (0, 150, 180)
        upper_red1 = (10, 255, 255)
        lower_red2 = (160, 150, 180)
        upper_red2 = (180, 255, 255)
        lower_orange_yellow = (10, 180, 200)
        upper_orange_yellow = (45, 255, 255)

        mask_red1 = cv2.inRange(hsv, lower_red1, upper_red1)
        mask_red2 = cv2.inRange(hsv, lower_red2, upper_red2)
        mask_orange_yellow = cv2.inRange(hsv, lower_orange_yellow, upper_orange_yellow)
        mask = cv2.bitwise_or(mask_red1, mask_red2)
        mask = cv2.bitwise_or(mask, mask_orange_yellow)

        kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (5, 5))
        mask = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel)
        mask = cv2.morphologyEx(mask, cv2.MORPH_DILATE, kernel)

        contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        current_frame_fire_detected = False 

        for cnt in contours:
            area = cv2.contourArea(cnt)
            if area < 3000:
                continue

            x, y, w, h = cv2.boundingRect(cnt)
            aspect_ratio = float(w) / h

            if 0.9 < aspect_ratio < 1.1:
                continue

            roi_mask = mask[y:y+h, x:x+w]
            fire_pixels = cv2.countNonZero(roi_mask)
            roi_total = w * h
            fire_ratio = fire_pixels / float(roi_total)

            if fire_ratio < 0.1:
                continue

            current_frame_fire_detected = True
            cv2.rectangle(frame, (x, y), (x + w, y + h), (0, 0, 255), 3)
            cv2.putText(frame, "FIRE DETECTED!", (x, y - 10),
                        cv2.FONT_HERSHEY_SIMPLEX, 1.0, (0, 0, 255), 3)
            rospy.logwarn(f"[{self.ns.strip('/')}] [FIRE] DETECTED at x={x}, y={y}, area={area}, ratio={fire_ratio:.2f}")

        if current_frame_fire_detected and not self.is_fire_detected:
            self.is_fire_detected = True
            rospy.logwarn(f"[{self.ns.strip('/')}] ğŸ”´ í™”ì¬ ê°ì§€! patrol_nodeì— ì •ì§€ ìš”ì²­.")
            self.fire_alert_pub.publish(Bool(True))
            
            if (time.time() - self.last_alarm_time > self.alarm_interval):
                self.last_alarm_time = time.time()
                self.play_alarm()

        elif not current_frame_fire_detected and self.is_fire_detected:
            self.is_fire_detected = False
            rospy.loginfo(f"[{self.ns.strip('/')}] ğŸŸ¢ í™”ì¬ ê°ì§€ í•´ì œ. patrol_nodeì— ì¬ì¶œë°œ ìš”ì²­.")
            self.fire_alert_pub.publish(Bool(False))


        cv2.imshow(f"[{self.ns.strip('/')}] Fire Detection", frame)
        cv2.imshow(f"[{self.ns.strip('/')}] Fire Mask", mask)
        cv2.waitKey(1)

if __name__ == '__main__':
    try:
        FireDetector()
        rospy.spin()
    except rospy.ROSInterruptException:
        pass
    cv2.destroyAllWindows()